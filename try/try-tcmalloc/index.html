<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>try tcmalloc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Henglin Li">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
<link href='/assets/stylesheets/bootstrap.min-e0e2914ec503fd07e90c90bb71395057.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/style-e81fa375b231bedf6cb2dbc6653570cc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/google_prettify/sons-of-obsidian-afb0925bfa2d994f17dab93e13fbf999.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">henglinli.github.io</a>
          <ul class="nav">
              
                <li><a href="/archive">Archive</a></li>
              
              
                <li><a href="/tags">Tags</a></li>
              
              
                <li><a href="/categories">Categories</a></li>
              
              
                <li><a href="/pages">Pages</a></li>
              
              
                <li><a href="/about">About Me</a></li>
              
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>try tcmalloc </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>2013-11-07</strong>
    </div>
    <div class="content">
      <h3 id="toc_0">Why</h3>

<p><a href="https://code.google.com/p/gperftools/" title="gperftools">TCMalloc</a>很早就玩过了，最近面试，讨论到关于程序优化的问题，
当时被逼问算法和数据结构，我的回答是：用常用的就行，编译器会自动优化的，
最主要的是减少系统调用。现在想来，最早应该考虑的是优化内存使用，
即替换系统默认的内存分配器或使用内存池——
使用<a href="https://code.google.com/p/gperftools/" title="gperftools">TCMlloc</a>或<a href="www.boost.org/libs/pool/%E2%80%8E" title="boost pool">Boost.Pool</a>。</p>

<h3 id="toc_1">How</h3>

<p>一开始只知道<a href="https://code.google.com/p/gperftools/" title="gperftools">TCMalloc</a>把内存分配的事情细化了：
小的内存分配用线程本地h缓存(thread-local cache);
大的内存分配用主缓存堆(central headp)分配;
分配的内存可在两者直接转移。现在才知道的是它是怎么替代系统
自带的分配器的：</p>

<p>1, GNU/Linux with glibc 
说来惭愧，一开始我以为<a href="http://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html" title="tls">malloc hook</a>就是来干这事的，
仔细看了文档发现<a href="http://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html" title="tls">它</a>是用来debug的。
看了<a href="https://code.google.com/p/gperftools/source/browse/src/libc_override_gcc_and_weak.h" title="glibc override">tcmalloc的相关代码</a>发现用的是<a href="http://en.wikipedia.org/wiki/Weak_symbol" title="weak symbol">Weak Symbol</a>alias。</p>

<pre><code>    #define ALIAS(tc_fn) __attribute__ ((alias (#tc_fn)))
    void* __libc_malloc(size_t size) ALIAS(tc_malloc);
</code></pre>

<p>2, OS X
OS X不支持alias，Google给出了<a href="https://code.google.com/p/gperftools/source/browse/src/libc_override_osx.h" title="OS X override">两种override的方法</a>:
A, Interposition Array</p>

<pre><code>    typedef struct interpose_s {
        void *new_func;
        void *orig_func;
    } interpose_t;
    #define MAC_INTERPOSE(newf,oldf) __attribute__((used)) \
        static const interpose_t macinterpose##newf##oldf \
        __attribute__ ((section(&quot;__DATA, __interpose&quot;))) = \
        { (void *) newf, (void *) oldf }
</code></pre>

<p>Google也指出了该方法得设置环境变量<code>DYLD_INSERT_LIBRARIES</code>，
不太好(is not much better), 让<a href="https://github.com/emeryberger/Hoard" title="hoard allocator">Hoard</a>情何以堪啊！
顺便提一下，有个基于该方法的更复杂通用的实现<a href="https://github.com/rentzsch/mach_override" title="mach_override">mach_override</a>。</p>

<p>B, <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man3/malloc_zone_malloc.3.html" title="malloc zone mannual">Malloc Zone</a>
Google认为Malloc Zone是更好的override。
Malloc Zone有个<code>malloc_zone_t</code>:</p>

<pre><code>    typedef struct _malloc_zone_t {
        //下面这句注释说明该结构的作用
        //Only zone implementors should depend on the layout of this structure;
        // ...
        void    *(*malloc)(struct _malloc_zone_t *zone, size_t size);
        // ...
        void    (*free)(struct _malloc_zone_t *zone, void *ptr);
        // ...
    } malloc_zone_t;
</code></pre>

<p>这样使用：创建一个<code>malloc_zone_t</code>，注册自己的malloc/free函数蔟到<code>malloc_zone_t</code>，
注册<code>malloc_zone_t</code>到系统。</p>

<p>知道来tc_malloc是如何override掉系统的分配器后，就知道怎么不替代了。
只要把<a href="https://code.google.com/p/gperftools/source/browse/src/libc_override.h" title="libc ovvrride">libc_override.h</a> <code>#if 0 #endif</code> 掉就OK了。
这样自己的程序就可以直接调用TCMalloc了。</p>

<p>还有个疑问就是：为什么Google不让用户直接调用的TCMalloc，而是override系统默认的分配器？</p>

<h3 id="toc_2">Then</h3>

<p>我写了些代码（单线程）测试了TCMalloc Hoard和系统自带的分配器比较。
结果是：在GNU/Linux平台(我用的是ArchLinux）TCMalloc和Hoard差不多，当然都比系统的好；
而OS X上却发现系统自带的比两者都好，而且TCMalloc根本自测都通不过。
最后我发现Apple公布OS X 10.9的开源代码中没有Malloc的实现了，
也许他们有比TCMalloc更好的实现吧。</p>

<h3 id="toc_3">End</h3>

<p>测试代码今后再给出，应为我想把TCMalloc从gperftools中提取出来，
不喜欢老的autoconf，想换成Cmake。
吐槽：OS X上编译TCMalloc好多警告，他们还在用brk/sbrk......</p>

<hr>

    </div>
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      <li>
        <a href="/categories#try-ref">try <span>4</span></a>
      </li>
    </ul>
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      <li>
        <a href="/tags#C/C++-ref">C/C++ <span>4</span></a>
      </li>
      <li>
        <a href="/tags#OS X-ref">OS X <span>2</span></a>
      </li>
      <li>
        <a href="/tags#GNU/Linux-ref">GNU/Linux <span>1</span></a>
      </li>
      <li>
        <a href="/tags#Memory manage-ref">Memory manage <span>1</span></a>
      </li>
      <li>
        <a href="/tags#Allocator-ref">Allocator <span>1</span></a>
      </li>
      <li>
        <a href="/tags#Memory Pool-ref">Memory Pool <span>1</span></a>
      </li>
      <li>
        <a href="/tags#TCMlloc-ref">TCMlloc <span>1</span></a>
      </li>
    </ul>
    <hr>
    <div class="pagination">
      <ul>
          <li class="prev"><a href="/try/try-os-x-static-link" title="Try OS X static link">&larr; Previous</a></li>

          <li><a href="/archive">Archive</a></li>

          <li class="next"><a href="/tutorial/botan-srp-%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90" title="Botan SRP 使用例子">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
    <div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'henglinli'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</div>


      </div>

      <hr>
      <div class="footer">
        <p>&copy; Henglin Li 2013
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42955283-1']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    
  </body>
</html>
