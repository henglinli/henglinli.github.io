<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Botan SRP 使用例子</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Botan SRP sample">
    <meta name="author" content="Henglin Li">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
<link href='/assets/stylesheets/bootstrap.min-e0e2914ec503fd07e90c90bb71395057.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/style-e81fa375b231bedf6cb2dbc6653570cc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/google_prettify/sons-of-obsidian-afb0925bfa2d994f17dab93e13fbf999.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">henglinli.github.io</a>
          <ul class="nav">
              
                <li><a href="/archive">Archive</a></li>
              
              
                <li><a href="/tags">Tags</a></li>
              
              
                <li><a href="/categories">Categories</a></li>
              
              
                <li><a href="/pages">Pages</a></li>
              
              
                <li><a href="/about">About Me</a></li>
              
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Botan SRP 使用例子 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>2013-11-21</strong>
    </div>
    <div class="content">
      <h3 id="toc_0">为神马Botan SRP？</h3>

<ul>
<li><a href="http://botan.randombit.net/" title="botan home">Botan</a> is a crypto library for C++ released under the permissive <a href="http://botan.randombit.net/license.html" title="botan license">BSD-2 (or FreeBSD) license</a>. C++和BSD系列的license就是最好的理由，它用了异常，我表示非常遗憾。</li>
<li><a href="http://en.wikipedia.org/wiki/Secure_Remote_Password_protocol" title="srp wiki">SRP(Secure Remote Password protocol)</a>一看名字就知道，
它比服务端保存hash密码安全多了。</li>
</ul>

<h3 id="toc_1">解释</h3>

<ul>
<li><p><a href="http://botan.randombit.net/" title="botan home">Botan</a>的SRP实现是<a href="http://tools.ietf.org/html/rfc5054" title="RFC 5054">RFC 5054</a>SRP-TLS，它和<a href="http://tools.ietf.org/html/rfc2945" title="RFC 2945">RFC 2945</a>(<a href="http://www.cnpaf.net/rfc/rfc2945.txt" title="RFC 2945 中文">中文</a>)不太一样。</p></li>
<li><p><a href="http://botan.randombit.net/" title="botan home">Botan</a>的SRP给个3个函数一个类（2个函数）共5个接口。</p></li>
<li><p>客户端函数</p>

<pre><code>// 验证服务器端发送来的B，并返回客户端key
std::pair&lt;BigInt,SymmetricKey&gt; // 返回 A 和 client key
BOTAN_DLL srp6_client_agree(
  const std::string&amp; username, // 用户名
  std::string&amp; password, // 密码，不会通过网络传输
  const std::string&amp; group_id, // 格式为&quot;modp/srp/1024&quot;, 1024表示1024位数
  const std::string&amp; hash_id, // 格式为&quot;MD-5&quot; &quot;SHA-160&quot;等
  const std::vector&lt;byte&gt;&amp; salt, // 最少128位，由服务器端得到
  const BigInt&amp; B, // 服务器端返回的B
  RandomNumberGenerator&amp; rng); // 可用Botan::AutoSeeded_RNG
</code></pre></li>
<li><p>服务器端函数</p>

<pre><code>// 注册用，生成&lt;username, verifier, salt&gt;三元组中的verifier,
// 需持久化该三元组
BigInt 
generate_srp6_verifier(
  const std::string&amp; identifier, // 用户名
  const std::string&amp; password, // 密码，或密码hash
  const std::vector&lt;byte&gt;&amp; salt, // 随机生成，最少128位
  const std::string&amp; group_id, // 必须和客户端一致
  const std::string&amp; hash_id); // 必须和客户端一致
</code></pre></li>
<li><p>服务器端类</p>

<pre><code>class SRP6_Server_Session
{
public:
// 生成 B
BigInt // 返回B，B要传送给客户端
step1(const BigInt&amp; v, // 持久化三元组中的verifier
      const std::string&amp; group_id, // 必须和客户端一致
      const std::string&amp; hash_id, // 必须和客户端一致
      RandomNumberGenerator&amp; rng); // 必须和客户端一致

// 返回服务器key
SymmetricKey step2(const BigInt&amp; A); // 客户端传送来的A
};
</code></pre></li>
<li><p>helper函数</p>

<pre><code>// 暂时没用到
std::string srp6_group_identifier(const BigInt&amp; N, const BigInt&amp; g);
</code></pre></li>
</ul>

<h3 id="toc_2">使用流程</h3>

<ul>
<li>客户端

<ol>
<li>发送<code>username</code></li>
<li>接收<code>salt</code> <code>B</code>, 使用<code>srp6_client_agree</code>生成<code>client key</code></li>
<li>使用<code>srp6_client_agree(B, salt)</code>生成<code>A</code> <code>client key</code>并发送</li>
<li>接收<code>server key</code>, 并判断是否等于<code>client key</code></li>
<li>发送<code>client done</code></li>
<li>接收<code>server done</code></li>
</ol></li>
<li>服务器端

<ol>
<li>接收<code>username</code>, 并判断是否存在</li>
<li>使用<code>setp1(verifier)</code> 生成<code>B</code>, 并发送<code>salt</code> <code>B</code> </li>
<li>接收<code>A</code> <code>client key</code>, 使用<code>setp2(A)</code>生成<code>server key</code></li>
<li>判断<code>server key</code>是否等于<code>client key</code>, 发送<code>server key</code></li>
<li>接收<code>client done</code></li>
<li>发送<code>server done</code></li>
</ol></li>
</ul>

<h3 id="toc_3">注意</h3>

<p><code>[RFC 2945]说：</code></p>

<p><code>“The host MUST send B after receiving A from the client, never before.”</code></p>

<p><code>但根据[Botan]的接口只能是: Host先发送B，client后发生A！</code></p>

<h3 id="toc_4">代码</h3>

<ul>
<li><a href="https://github.com/henglinli/TheServer/tree/master/botan_srp_sample">https://github.com/henglinli/TheServer/tree/master/botan_srp_sample</a></li>
</ul>

<hr>

    </div>
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      <li>
        <a href="/categories#tutorial-ref">tutorial <span>3</span></a>
      </li>
    </ul>
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      <li>
        <a href="/tags#C++-ref">C++ <span>4</span></a>
      </li>
      <li>
        <a href="/tags#Botan-ref">Botan <span>1</span></a>
      </li>
      <li>
        <a href="/tags#SRP-ref">SRP <span>1</span></a>
      </li>
    </ul>
    <hr>
    <div class="pagination">
      <ul>
          <li class="prev"><a href="/try/try-tcmalloc" title="try tcmalloc">&larr; Previous</a></li>

          <li><a href="/archive">Archive</a></li>

          <li class="next"><a href="/study/boost-asio-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E8%AE%BE%E8%AE%A1" title="Boost.Asio 连接池的设计">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
    <div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'henglinli'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</div>


      </div>

      <hr>
      <div class="footer">
        <p>&copy; Henglin Li 2013
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42955283-1']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    
  </body>
</html>
